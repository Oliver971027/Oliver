<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Travel Map (Google Sheets)</title>
    <style>
        /* 移除邊距，確保地圖滿版 */
        body { margin: 0; padding: 0; background-color: #E1F5FE; overflow: hidden; }
        #chartdiv { width: 100%; height: 100vh; }
    </style>
</head>
<body>

<div id="chartdiv"></div>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/worldHigh.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<script>
am5.ready(function() {

    // =========================================================
    // 1. 設定區 (Configuration)
    // =========================================================
    
    // ★ 請將此處換成您的 Google Sheet CSV 連結
    // 格式要求：第一欄為 Country_Code (如 TW, JP), 第二欄為 Notion_Link
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTfNBKFYRbs8r4NoYBSFFrx7K87vdvlhXcmQcnR9PbZED4BSyYadZENz4fPU4e4bes5JyTQRfrctWKD/pub?gid=0&single=true&output=csv";

    // 設定您的居住地代碼 (顯示為黃/橙色)
    const HOME_ID = "TW"; 

    // 配色設定
    const colors = {
        // 海洋：改為極淺藍色 (Light Blue 50)
        ocean: am5.color(0xE1F5FE), 

        // 居住地 (台灣)
        home: {
            normal: am5.color(0xFFC107), // 亮橙
            hover:  am5.color(0xFF8F00)  // 深橙
        },

        // 去過的國家
        visited: {
            normal: am5.color(0xC8E6C9), // 鮮綠
            hover:  am5.color(0x66BB6A)  // 深綠
        },

        // 沒去過的國家
        unvisited: {
            normal: am5.color(0xD1D1D1), // 淺灰
            hover:  am5.color(0xA9A9A9)  // 深灰
        }
    };

    // =========================================================
    // 2. 建立地圖 (Map Setup)
    // =========================================================
    var root = am5.Root.new("chartdiv");
    root.setThemes([ am5themes_Animated.new(root) ]);

    var chart = root.container.children.push(am5map.MapChart.new(root, {
        panX: "rotateX", // 允許左右無限捲動
        panY: "translateY",
        projection: am5map.geoMercator(), // 平面地圖投影
        minZoomLevel: 1,
        maxZoomLevel: 32,
    }));

    // 設定背景顏色 (海洋)
    chart.chartContainer.set("background", am5.Rectangle.new(root, {
        fill: colors.ocean,
        fillOpacity: 1
    }));

    // =========================================================
    // 3. 國家圖層 (Land Series)
    // =========================================================
    var polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_worldHigh,
        exclude: ["AQ"] // 排除南極洲
    }));

    // 設定預設樣式 (對應 "未去過")
    polygonSeries.mapPolygons.template.setAll({
        tooltipText: "{name}",
        toggleKey: "active",
        interactive: true,
        fill: colors.unvisited.normal,    
        stroke: am5.color(0xffffff),      
        strokeWidth: 0.5
    });

    // 建立 Hover 狀態
    polygonSeries.mapPolygons.template.states.create("hover", {
        fill: colors.unvisited.hover      
    });

    // =========================================================
    // 4. 智慧填色邏輯 (Adapter)
    // =========================================================
    polygonSeries.mapPolygons.template.adapters.add("fill", function(fill, target) {
        
        // 從資料中取得狀態 (home / visited / unvisited)
        var status = "unvisited"; 
        if (target.dataItem && target.dataItem.dataContext && target.dataItem.dataContext.status) {
            status = target.dataItem.dataContext.status;
        }

        if (target.isHover()) {
            // --- Hover 狀態 ---
            if (status === "home")    return colors.home.hover;    
            if (status === "visited") return colors.visited.hover; 
            return colors.unvisited.hover;                         
        } else {
            // --- 一般狀態 ---
            if (status === "home")    return colors.home.normal;    
            if (status === "visited") return colors.visited.normal; 
            return colors.unvisited.normal;                         
        }
    });

    // 點擊事件：開啟 Notion 連結
    polygonSeries.mapPolygons.template.events.on("click", function(ev) {
        var data = ev.target.dataItem.dataContext;
        if (data.url && data.url.trim() !== "") {
            window.open(data.url, "_blank");
        }
    });

    // =========================================================
    // 5. 讀取 Google Sheets CSV 資料
    // =========================================================
    // 使用 fetch 抓取資料
    fetch(CSV_URL)
        .then(response => response.text())
        .then(csvText => {
            // 解析 CSV
            // 假設第一列是標題，從第二列開始讀取 (slice(1))
            // 如果您的 CSV 沒有標題列，請移除 .slice(1)
            var rows = csvText.split(/\r?\n/).slice(1);
            var mapData = [];

            // 1. 先加入居住地 (確保台灣永遠是 Home 狀態，即使 CSV 沒寫)
            // 如果 CSV 裡也有 TW，下面的迴圈會覆蓋這個設定，但狀態判斷會優先保留 Home 邏輯
            mapData.push({
                id: HOME_ID,
                status: "home",
                url: "" // 您可以在此設定台灣的預設連結
            });

            // 2. 處理 CSV 資料
            rows.forEach(function(row) {
                var cols = row.split(",");
                // 確保該行有資料
                if (cols.length >= 1) {
                    var countryCode = cols[0].trim(); // 第一欄：Country_Code
                    var notionLink = cols[1] ? cols[1].trim() : ""; // 第二欄：Notion_Link

                    if (countryCode) {
                        // 判斷狀態
                        var currentStatus = "visited";
                        if (countryCode === HOME_ID) {
                            currentStatus = "home";
                        }

                        mapData.push({
                            id: countryCode,
                            status: currentStatus,
                            url: notionLink
                        });
                    }
                }
            });

            // 將資料注入地圖
            polygonSeries.data.setAll(mapData);
            console.log("地圖資料載入完成", mapData);
        })
        .catch(error => {
            console.error("讀取 Google Sheet 失敗:", error);
            // 本地測試時如果是 file:// 協議可能會被瀏覽器擋下 CORS
            if (window.location.protocol === 'file:') {
                alert("錯誤：無法讀取 CSV。\n瀏覽器安全性限制無法直接讀取本地檔案的外部連結。\n請使用 VSCode 的 'Live Server' 套件來開啟此網頁。");
            }
        });

    // =========================================================
    // 6. 控制項 (Controls)
    // =========================================================
    
    // 縮放控制項
    var zoomControl = chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
    var homeButton = zoomControl.homeButton;
    homeButton.set("visible", true);

    // Home 按鈕功能：回到台灣並縮放至全景
    homeButton.events.on("click", function() {
        chart.zoomToGeoPoint({ latitude: 23.5, longitude: 121 }, 1, true);
    });

    // 初始動畫
    chart.appear(1000, 100);
});
</script>

</body>
</html>
